# üè¶ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

## üìã –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Railway

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Railway:

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ÆKassa
YUKASSA_SHOP_ID=–≤–∞—à_shop_id
YUKASSA_SECRET_KEY=–≤–∞—à_secret_key
YUKASSA_WEBHOOK_SECRET=–≤–∞—à_webhook_secret
```

## üîß –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ÆKassa

### 1. Shop ID –∏ Secret Key
1. –í–æ–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa](https://yookassa.ru/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **"–ù–∞—Å—Ç—Ä–æ–π–∫–∏"** ‚Üí **"API –∏ webhook"**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ:
   - **shopId** ‚Üí `YUKASSA_SHOP_ID`
   - **–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á** ‚Üí `YUKASSA_SECRET_KEY`

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
1. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è"** ‚Üí **"HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"**
2. **URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**: `https://–≤–∞—à-–¥–æ–º–µ–Ω-railway.up.railway.app/webhook/yukassa`
3. **–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è** (–æ—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∞–º–∏):
   - ‚úÖ `payment.succeeded` - –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂  
   - ‚úÖ `payment.waiting_for_capture` - –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
   - ‚úÖ `payment.canceled` - –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞
4. **–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –∑–∞–¥–∞–π—Ç–µ ‚Üí `YUKASSA_WEBHOOK_SECRET`

## üöÄ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã** (–≤–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
  - –ü–†–û–ì–†–ï–°–°: `https://yookassa.ru/my/i/aFuvni8_S7Z9/l`
  - –ú–ê–ö–°–ò–ú–£–ú: `https://yookassa.ru/my/i/aFuv3xVOei-f/l`
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏** —á–µ—Ä–µ–∑ webhook
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞** –≤ –±–æ—Ç–µ
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### üîó API Endpoints
- `POST /webhook/yukassa` - –ø–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ÆKassa
- `GET /api/payment/:payment_id/status` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
- `GET /api/user/:telegram_id/payments` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É:
1. –ù–∞–∂–∏–º–∞–µ—Ç "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å" –≤ –±–æ—Ç–µ
2. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ –±—ã—Å—Ç—Ä–æ–π —Å—Å—ã–ª–∫–µ –ÆKassa
3. –°–æ–≤–µ—Ä—à–∞–µ—Ç –ø–ª–∞—Ç–µ–∂

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è:
1. –ÆKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ `/webhook/yukassa`
2. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)
3. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É"
2. –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `yukassa_payments` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- ID –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç –ÆKassa
- Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°—É–º–º–∞ –∏ —Ç–∞—Ä–∏—Ñ
- –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
- –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **Webhook URL**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –ÆKassa —á–µ—Ä–µ–∑ "HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
2. **HTTPS**: Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTPS (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ÆKassa)
3. **–ü–æ—Ä—Ç—ã**: –ÆKassa –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ 443 –∏ 8443 (Railway –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 443)
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: 
   - Webhook secret –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - IP-–∞–¥—Ä–µ—Å–∞ –ÆKassa –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS/TLS 1.2+
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –ÆKassa –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### IP-–∞–¥—Ä–µ—Å–∞ –ÆKassa
–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö IP:
- `185.71.76.0/27`, `185.71.77.0/27`
- `77.75.153.0/25`, `77.75.154.128/25`
- `77.75.156.11`, `77.75.156.35`
- `2a02:5180::/32` (IPv6)

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **–ü–æ IP**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
- **–ü–æ –ø–æ–¥–ø–∏—Å–∏**: HMAC-SHA256 —Å —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º
- **–ü–æ —Å—Ç–∞—Ç—É—Å—É**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π
–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `üì® –ü–æ–ª—É—á–µ–Ω webhook –æ—Ç –ÆKassa`
- `‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ webhook`
- `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
- `GET /health` - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
- –õ–æ–≥–∏ Railway –ø–æ–∫–∞–∂—É—Ç webhook –∑–∞–ø—Ä–æ—Å—ã
- –í –±–æ—Ç–µ –∫–Ω–æ–ø–∫–∞ "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É"

## üéâ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ Railway —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –≤–∞—à–∏–º —Å—Å—ã–ª–∫–∞–º
- –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –í–µ–¥–µ—Ç —É—á–µ—Ç –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ 