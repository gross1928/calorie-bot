-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ 'profiles', Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
CREATE TABLE IF NOT EXISTS public.profiles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    chat_id BIGINT NOT NULL,
    gender TEXT CHECK (gender IN ('male', 'female')),
    age INT,
    height_cm INT,
    weight_kg NUMERIC(5, 2),
    goal TEXT CHECK (goal IN ('lose_weight', 'maintain_weight', 'gain_mass')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ 'meals', Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
CREATE TABLE IF NOT EXISTS public.meals (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    calories INT NOT NULL,
    protein NUMERIC(5, 2),
    fat NUMERIC(5, 2),
    carbs NUMERIC(5, 2),
    meal_type TEXT, -- e.g., 'photo', 'manual'
    photo_url TEXT, -- Link to the photo if available
    eaten_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ 'weight_g' Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ 'meals', ÐµÑÐ»Ð¸ ÐµÐµ Ð½ÐµÑ‚
ALTER TABLE public.meals ADD COLUMN IF NOT EXISTS weight_g INT;

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ 'ingredients' Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ 'meals', ÐµÑÐ»Ð¸ ÐµÐµ Ð½ÐµÑ‚
ALTER TABLE public.meals ADD COLUMN IF NOT EXISTS ingredients TEXT[];

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸ Ð´Ð»Ñ Ð´Ð½ÐµÐ²Ð½Ð¾Ð¹ Ð½Ð¾Ñ€Ð¼Ñ‹ ÐšÐ‘Ð–Ð£ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ 'profiles', ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS daily_calories NUMERIC;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS daily_protein NUMERIC;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS daily_fat NUMERIC;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS daily_carbs NUMERIC;

    SELECT
        con.conname AS constraint_name,
        ccu.table_schema AS table_schema,
        ccu.table_name,
        ccu.column_name,
        pg_get_constraintdef(con.oid) AS definition
    FROM
        pg_constraint AS con
    JOIN
        pg_namespace AS n ON n.oid = con.connamespace
    JOIN
        information_schema.constraint_column_usage AS ccu ON con.conname = ccu.constraint_name AND n.nspname = ccu.table_schema
    WHERE
        con.contype = 'c' AND ccu.table_name = 'profiles';

SELECT * FROM pg_policies WHERE tablename = 'meals';

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð»Ð°Ð½Ð¾Ð² Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº
CREATE TABLE IF NOT EXISTS public.workout_plan_data (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    experience TEXT NOT NULL, -- beginner, intermediate, advanced
    goal TEXT NOT NULL, -- weightloss, muscle, maintain, health
    priority_zones TEXT[], -- Ð¼Ð°ÑÑÐ¸Ð² Ð·Ð¾Ð½: back, chest, legs, shoulders, core
    injuries TEXT, -- Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‚Ñ€Ð°Ð²Ð¼ Ð¸Ð»Ð¸ 'none'
    location TEXT NOT NULL, -- home, gym, outdoor
    frequency_per_week INT NOT NULL, -- ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ
    duration_minutes INT NOT NULL, -- Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸
    preferred_types TEXT[], -- Ð¼Ð°ÑÑÐ¸Ð² Ñ‚Ð¸Ð¿Ð¾Ð²: strength, cardio, hiit, yoga, stretching
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð»Ð°Ð½Ð¾Ð² Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ
CREATE TABLE IF NOT EXISTS public.nutrition_plan_data (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    activity_level TEXT NOT NULL, -- sedentary, light, active, heavy
    calorie_goal TEXT NOT NULL, -- deficit, surplus, maintain
    allergies TEXT[], -- Ð¼Ð°ÑÑÐ¸Ð² Ð°Ð»Ð»ÐµÑ€Ð³Ð¸Ð¹ Ð¸Ð»Ð¸ ['none']
    diet_type TEXT NOT NULL, -- regular, vegetarian, vegan, keto
    meals_per_day TEXT NOT NULL, -- three_main, five_six_small
    product_limitations TEXT, -- Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ Ð¸Ð»Ð¸ 'none'
    supplements_interest TEXT NOT NULL, -- yes, no
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
CREATE POLICY "Allow public all operations on workout_plan_data" 
ON workout_plan_data FOR ALL 
TO public 
USING (true) 
WITH CHECK (true);

CREATE POLICY "Allow public all operations on nutrition_plan_data" 
ON nutrition_plan_data FOR ALL 
TO public 
USING (true) 
WITH CHECK (true);

-- Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ water_intake Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ‚Ð¸Ð¿Ð°Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
CREATE TABLE water_intake (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    amount_ml INTEGER NOT NULL CHECK (amount_ml > 0),
    recorded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¸Ð½Ð´ÐµÐºÑÑ‹
CREATE INDEX idx_water_intake_user_id ON water_intake(user_id);
CREATE INDEX idx_water_intake_recorded_at ON water_intake(recorded_at);

-- Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ RLS
ALTER TABLE water_intake ENABLE ROW LEVEL SECURITY;

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ RLS
CREATE POLICY "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ ÑÐ²Ð¾Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸" ON water_intake
    FOR ALL USING (true);

    CREATE TABLE workout_records (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    telegram_id TEXT NOT NULL,
    workout_type TEXT DEFAULT 'general',
    duration_minutes INTEGER DEFAULT 30,
    exercises TEXT,
    intensity TEXT,
    calories_burned INTEGER DEFAULT 0,
    notes TEXT,
    date DATE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
ALTER TABLE workout_records ENABLE ROW LEVEL SECURITY;

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ (Ð¿Ð¾ÐºÐ° Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ)
CREATE POLICY "Allow read access" ON workout_records FOR SELECT USING (true);

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ Ð²ÑÑ‚Ð°Ð²ÐºÐ¸ Ð²ÑÐµÑ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹  
CREATE POLICY "Allow insert access" ON workout_records FOR INSERT WITH CHECK (true);

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ Ð´Ð»Ñ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð³Ð¾ Ð²ÐµÑÐ°
ALTER TABLE public.profiles
ADD COLUMN target_weight_kg NUMERIC;

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ Ð´Ð»Ñ ÑÑ€Ð¾ÐºÐ° Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ Ñ†ÐµÐ»Ð¸ Ð² Ð¼ÐµÑÑÑ†Ð°Ñ…
ALTER TABLE public.profiles
ADD COLUMN timeframe_months INT;

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ Ð´Ð»Ñ Ñ‡Ð°ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾ÑÑÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
ALTER TABLE public.profiles
ADD COLUMN timezone TEXT DEFAULT 'Europe/Moscow';

-- ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ð´Ð»Ñ ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº (Ñ…Ð¾Ñ€Ð¾ÑˆÐ°Ñ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°)
COMMENT ON COLUMN public.profiles.target_weight_kg IS 'Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ Ð²ÐµÑ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² ÐºÐ¸Ð»Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð°Ñ….';
COMMENT ON COLUMN public.profiles.timeframe_months IS 'Ð¡Ñ€Ð¾Ðº Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ Ñ†ÐµÐ»Ð¸ Ð² Ð¼ÐµÑÑÑ†Ð°Ñ….';
COMMENT ON COLUMN public.profiles.timezone IS 'Ð§Ð°ÑÐ¾Ð²Ð¾Ð¹ Ð¿Ð¾ÑÑ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹.';

-- ðŸ† Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ Ð§Ð•Ð›Ð›Ð•ÐÐ”Ð–Ð•Ð™ - Ð£Ð¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ SQL Ð´Ð»Ñ Supabase
-- Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ñ‚Ð¸Ð¿Ð¾Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ñ‹ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

-- 1. Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° ÐµÐ¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶ÐµÐ¹
CREATE TABLE IF NOT EXISTS weekly_challenges (
    id BIGSERIAL PRIMARY KEY,
    week_start TIMESTAMPTZ NOT NULL UNIQUE, -- ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð½ÐµÐ´ÐµÐ»Ð¸ (Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº)
    title TEXT NOT NULL,                    -- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°
    description TEXT NOT NULL,              -- ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°
    target_value INTEGER NOT NULL,          -- Ð¦ÐµÐ»ÐµÐ²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 70000 ÑˆÐ°Ð³Ð¾Ð²)
    unit TEXT NOT NULL,                     -- Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ (ÑˆÐ°Ð³Ð¾Ð², Ð»Ð¸Ñ‚Ñ€Ð¾Ð², Ð¼Ð¸Ð½ÑƒÑ‚, ÐºÐ¼, Ñ€Ð°Ð·)
    type TEXT NOT NULL,                     -- Ð¢Ð¸Ð¿ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð° (steps, water, workout_time, distance, exercises)
    motivation TEXT NOT NULL,               -- ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    created_at TIMESTAMPTZ DEFAULT NOW()   -- Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ
);

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ°
CREATE INDEX IF NOT EXISTS idx_weekly_challenges_week_start ON weekly_challenges(week_start);
CREATE INDEX IF NOT EXISTS idx_weekly_challenges_type ON weekly_challenges(type);

-- 2. Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ ÑˆÐ°Ð³Ð¾Ð²
CREATE TABLE IF NOT EXISTS steps_tracking (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    date DATE NOT NULL,                     -- Ð”Ð°Ñ‚Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð°Ñ‚Ð°, Ð±ÐµÐ· Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸)
    steps INTEGER NOT NULL DEFAULT 0,       -- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ð·Ð° Ð´ÐµÐ½ÑŒ
    updated_at TIMESTAMPTZ DEFAULT NOW(),   -- ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
    
    -- Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: Ð¾Ð´Ð¸Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð¼ÐµÑ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð½Ñƒ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð½Ð° Ð´Ð°Ñ‚Ñƒ
    UNIQUE(user_id, date)
);

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ°
CREATE INDEX IF NOT EXISTS idx_steps_tracking_user_date ON steps_tracking(user_id, date);
CREATE INDEX IF NOT EXISTS idx_steps_tracking_date ON steps_tracking(date);

-- 3. Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ profiles (ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½ÐµÑ‚)
ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS notifications_enabled BOOLEAN DEFAULT true;

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ‹Ð¼Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸ÑÐ¼Ð¸
CREATE INDEX IF NOT EXISTS idx_profiles_notifications ON profiles(notifications_enabled) WHERE notifications_enabled = true;

-- 4. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ updated_at Ð² steps_tracking
DROP TRIGGER IF EXISTS update_steps_tracking_updated_at ON steps_tracking;
CREATE TRIGGER update_steps_tracking_updated_at
    BEFORE UPDATE ON steps_tracking
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 5. Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Row Level Security (RLS) - ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ
ALTER TABLE weekly_challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE steps_tracking ENABLE ROW LEVEL SECURITY;

-- 6. ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð´Ð»Ñ weekly_challenges
DROP POLICY IF EXISTS "Allow all read access to weekly_challenges" ON weekly_challenges;
CREATE POLICY "Allow all read access to weekly_challenges" ON weekly_challenges
    FOR SELECT USING (true);

DROP POLICY IF EXISTS "Allow service role full access to weekly_challenges" ON weekly_challenges;
CREATE POLICY "Allow service role full access to weekly_challenges" ON weekly_challenges
    FOR ALL USING (auth.role() = 'service_role');

-- 7. ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð´Ð»Ñ steps_tracking
DROP POLICY IF EXISTS "Allow all read access to steps_tracking" ON steps_tracking;
CREATE POLICY "Allow all read access to steps_tracking" ON steps_tracking
    FOR SELECT USING (true);

DROP POLICY IF EXISTS "Allow service role full access to steps_tracking" ON steps_tracking;
CREATE POLICY "Allow service role full access to steps_tracking" ON steps_tracking
    FOR ALL USING (auth.role() = 'service_role');

-- 8. ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ðº Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼
COMMENT ON TABLE weekly_challenges IS 'Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹';
COMMENT ON TABLE steps_tracking IS 'ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ ÑˆÐ°Ð³Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¿Ð¾ Ð´Ð½ÑÐ¼';

COMMENT ON COLUMN weekly_challenges.week_start IS 'Ð”Ð°Ñ‚Ð° Ð½Ð°Ñ‡Ð°Ð»Ð° Ð½ÐµÐ´ÐµÐ»Ð¸ (Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº) Ð´Ð»Ñ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°';
COMMENT ON COLUMN weekly_challenges.target_value IS 'Ð¦ÐµÐ»ÐµÐ²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°';
COMMENT ON COLUMN weekly_challenges.type IS 'Ð¢Ð¸Ð¿ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°: steps, water, workout_time, distance, exercises';

COMMENT ON COLUMN steps_tracking.date IS 'Ð”Ð°Ñ‚Ð° ÑƒÑ‡ÐµÑ‚Ð° ÑˆÐ°Ð³Ð¾Ð² (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð°Ñ‚Ð°, Ð±ÐµÐ· Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸)';
COMMENT ON COLUMN steps_tracking.steps IS 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ð·Ð° ÑƒÐºÐ°Ð·Ð°Ð½Ð½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ';

-- 9. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶ Ð½Ð° Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ
INSERT INTO weekly_challenges (week_start, title, description, target_value, unit, type, motivation) 
VALUES 
    (
        date_trunc('week', NOW() AT TIME ZONE 'Europe/Moscow') + INTERVAL '1 day',
        'ÐŸÑ€Ð¾Ð¹Ñ‚Ð¸ 70,000 ÑˆÐ°Ð³Ð¾Ð² Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ!',
        'ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ - Ð¾ÑÐ½Ð¾Ð²Ð° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ! Ð”Ð²Ð¸Ð³Ð°Ð¹Ñ‚ÐµÑÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð³Ð½Ð¸Ñ‚Ðµ 70,000 ÑˆÐ°Ð³Ð¾Ð² Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ. Ð­Ñ‚Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ 10,000 ÑˆÐ°Ð³Ð¾Ð² Ð² Ð´ÐµÐ½ÑŒ.',
        70000,
        'ÑˆÐ°Ð³Ð¾Ð²',
        'steps',
        'ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑˆÐ°Ð³ Ð¿Ñ€Ð¸Ð±Ð»Ð¸Ð¶Ð°ÐµÑ‚ Ð²Ð°Ñ Ðº Ñ†ÐµÐ»Ð¸! Ð’Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÑ‚Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ! ðŸ’ª'
    )
ON CONFLICT (week_start) DO NOTHING;

-- Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†
SELECT 'Ð’ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð´Ð»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶ÐµÐ¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹! ðŸŽ‰' as result; 

ALTER TABLE weekly_challenges DISABLE ROW LEVEL SECURITY;
ALTER TABLE steps_tracking DISABLE ROW LEVEL SECURITY;

-- ðŸ“Š ÐÐ”ÐÐŸÐ¢Ð˜Ð ÐžÐ’ÐÐÐÐÐ¯ SQL Ð¡Ð¥Ð•ÐœÐ Ð”Ð›Ð¯ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ« Ð•Ð–Ð•ÐÐ•Ð”Ð•Ð›Ð¬ÐÐžÐ™ ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ˜ Ð’Ð•Ð¡Ð
-- Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ Ð±Ð°Ð·Ð¾Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ñ…

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¿Ð¾Ð´ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ ÑÑ…ÐµÐ¼Ñƒ)
CREATE TABLE IF NOT EXISTS public.user_subscriptions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    plan VARCHAR(20) NOT NULL DEFAULT 'free', -- 'free', 'premium', 'vip'
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE, -- NULL Ð´Ð»Ñ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ð¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
    payment_id VARCHAR(255), -- ID Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð° Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    UNIQUE(user_id)
);

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾)
CREATE TABLE IF NOT EXISTS public.daily_usage (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    photos_analyzed INTEGER NOT NULL DEFAULT 0,
    ai_questions_asked INTEGER NOT NULL DEFAULT 0,
    workouts_generated INTEGER NOT NULL DEFAULT 0,
    manual_entries INTEGER NOT NULL DEFAULT 0, -- Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ ÐµÐ´Ñ‹
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    UNIQUE(user_id, date)
);

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð²ÐµÑÐ° (Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…)
CREATE TABLE IF NOT EXISTS public.weight_history (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    weight_kg DECIMAL(5,2) NOT NULL, -- Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ Ñ profiles.weight_kg
    notes TEXT, -- Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸
    source VARCHAR(20) DEFAULT 'manual', -- 'manual', 'profile_update', 'weekly_check'
    recorded_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹ Ð¾ Ð²ÐµÑÐµ
CREATE TABLE IF NOT EXISTS public.weight_reminders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    reminder_date DATE NOT NULL,
    reminder_type VARCHAR(20) DEFAULT 'weekly', -- 'weekly', 'monthly', 'custom'
    is_sent BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    UNIQUE(user_id, reminder_date)
);

-- Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user_id ON public.user_subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_plan ON public.user_subscriptions(plan);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_active ON public.user_subscriptions(is_active);

CREATE INDEX IF NOT EXISTS idx_daily_usage_user_id ON public.daily_usage(user_id);
CREATE INDEX IF NOT EXISTS idx_daily_usage_date ON public.daily_usage(date);
CREATE INDEX IF NOT EXISTS idx_daily_usage_user_date ON public.daily_usage(user_id, date);

CREATE INDEX IF NOT EXISTS idx_weight_history_user_id ON public.weight_history(user_id);
CREATE INDEX IF NOT EXISTS idx_weight_history_recorded_at ON public.weight_history(recorded_at);
CREATE INDEX IF NOT EXISTS idx_weight_history_user_recorded ON public.weight_history(user_id, recorded_at);

CREATE INDEX IF NOT EXISTS idx_weight_reminders_user_id ON public.weight_reminders(user_id);
CREATE INDEX IF NOT EXISTS idx_weight_reminders_date ON public.weight_reminders(reminder_date);

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ñ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ)
CREATE OR REPLACE FUNCTION increment_usage(
    p_user_id BIGINT,
    p_date DATE,
    p_field VARCHAR(50)
)
RETURNS VOID AS $$
BEGIN
    INSERT INTO public.daily_usage (user_id, date, photos_analyzed, ai_questions_asked, workouts_generated, manual_entries)
    VALUES (p_user_id, p_date, 
            CASE WHEN p_field = 'photos_analyzed' THEN 1 ELSE 0 END,
            CASE WHEN p_field = 'ai_questions_asked' THEN 1 ELSE 0 END,
            CASE WHEN p_field = 'workouts_generated' THEN 1 ELSE 0 END,
            CASE WHEN p_field = 'manual_entries' THEN 1 ELSE 0 END)
    ON CONFLICT (user_id, date) 
    DO UPDATE SET
        photos_analyzed = CASE WHEN p_field = 'photos_analyzed' THEN daily_usage.photos_analyzed + 1 ELSE daily_usage.photos_analyzed END,
        ai_questions_asked = CASE WHEN p_field = 'ai_questions_asked' THEN daily_usage.ai_questions_asked + 1 ELSE daily_usage.ai_questions_asked END,
        workouts_generated = CASE WHEN p_field = 'workouts_generated' THEN daily_usage.workouts_generated + 1 ELSE daily_usage.workouts_generated END,
        manual_entries = CASE WHEN p_field = 'manual_entries' THEN daily_usage.manual_entries + 1 ELSE daily_usage.manual_entries END,
        updated_at = timezone('utc'::text, now());
END;
$$ LANGUAGE plpgsql;

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾ telegram_id (Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ)
CREATE OR REPLACE FUNCTION get_user_profile_by_telegram_id(p_telegram_id BIGINT)
RETURNS TABLE(
    id BIGINT,
    telegram_id BIGINT,
    username TEXT,
    first_name TEXT,
    gender TEXT,
    age INT,
    height_cm INT,
    weight_kg NUMERIC(5,2),
    target_weight_kg NUMERIC,
    goal TEXT,
    timeframe_months INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id,
        p.telegram_id,
        p.username,
        p.first_name,
        p.gender,
        p.age,
        p.height_cm,
        p.weight_kg,
        p.target_weight_kg,
        p.goal,
        p.timeframe_months
    FROM public.profiles p
    WHERE p.telegram_id = p_telegram_id;
END;
$$ LANGUAGE plpgsql;

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ)
CREATE OR REPLACE FUNCTION get_user_usage_stats(p_user_id BIGINT)
RETURNS TABLE(
    today_photos INTEGER,
    today_questions INTEGER,
    today_manual_entries INTEGER,
    month_workouts INTEGER,
    total_weight_records INTEGER,
    last_weight DECIMAL(5,2),
    weight_trend VARCHAR(20),
    current_weight DECIMAL(5,2)
) AS $$
DECLARE
    this_month_start DATE := DATE_TRUNC('month', CURRENT_DATE)::DATE;
    today DATE := CURRENT_DATE;
BEGIN
    RETURN QUERY
    SELECT 
        COALESCE(du.photos_analyzed, 0) as today_photos,
        COALESCE(du.ai_questions_asked, 0) as today_questions,
        COALESCE(du.manual_entries, 0) as today_manual_entries,
        COALESCE(monthly.total_workouts, 0)::INTEGER as month_workouts,
        COALESCE(weight_stats.total_records, 0)::INTEGER as total_weight_records,
        weight_stats.last_weight,
        weight_stats.trend,
        profile_weight.current_weight
    FROM (
        SELECT p_user_id as user_id
    ) u
    LEFT JOIN public.daily_usage du ON du.user_id = u.user_id AND du.date = today
    LEFT JOIN (
        SELECT 
            user_id,
            SUM(workouts_generated) as total_workouts
        FROM public.daily_usage 
        WHERE user_id = p_user_id 
        AND date >= this_month_start
        GROUP BY user_id
    ) monthly ON monthly.user_id = u.user_id
    LEFT JOIN (
        SELECT 
            user_id,
            COUNT(*) as total_records,
            (SELECT weight_kg FROM public.weight_history WHERE user_id = p_user_id ORDER BY recorded_at DESC LIMIT 1) as last_weight,
            CASE 
                WHEN COUNT(*) < 2 THEN 'insufficient_data'
                WHEN (SELECT weight_kg FROM public.weight_history WHERE user_id = p_user_id ORDER BY recorded_at DESC LIMIT 1) > 
                     (SELECT weight_kg FROM public.weight_history WHERE user_id = p_user_id ORDER BY recorded_at DESC LIMIT 1 OFFSET 1) 
                THEN 'increasing'
                WHEN (SELECT weight_kg FROM public.weight_history WHERE user_id = p_user_id ORDER BY recorded_at DESC LIMIT 1) < 
                     (SELECT weight_kg FROM public.weight_history WHERE user_id = p_user_id ORDER BY recorded_at DESC LIMIT 1 OFFSET 1) 
                THEN 'decreasing'
                ELSE 'stable'
            END as trend
        FROM public.weight_history 
        WHERE user_id = p_user_id
        GROUP BY user_id
    ) weight_stats ON weight_stats.user_id = u.user_id
    LEFT JOIN (
        SELECT 
            id as user_id,
            weight_kg as current_weight
        FROM public.profiles
        WHERE id = p_user_id
    ) profile_weight ON profile_weight.user_id = u.user_id;
END;
$$ LANGUAGE plpgsql;

-- Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Row Level Security
ALTER TABLE public.user_subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.daily_usage ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.weight_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.weight_reminders ENABLE ROW LEVEL SECURITY;

-- ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° (ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¾Ð¼)
CREATE POLICY "Allow public all operations on user_subscriptions" 
ON public.user_subscriptions FOR ALL 
TO public 
USING (true) 
WITH CHECK (true);

CREATE POLICY "Allow public all operations on daily_usage" 
ON public.daily_usage FOR ALL 
TO public 
USING (true) 
WITH CHECK (true);

CREATE POLICY "Allow public all operations on weight_history" 
ON public.weight_history FOR ALL 
TO public 
USING (true) 
WITH CHECK (true);

CREATE POLICY "Allow public all operations on weight_reminders" 
ON public.weight_reminders FOR ALL 
TO public 
USING (true) 
WITH CHECK (true);

-- ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ðº Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼
COMMENT ON TABLE public.user_subscriptions IS 'ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (free, premium, vip) - Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¿Ð¾Ð´ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ ÑÑ…ÐµÐ¼Ñƒ';
COMMENT ON TABLE public.daily_usage IS 'Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ - Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾';
COMMENT ON TABLE public.weight_history IS 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð²ÐµÑÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ - Ð´Ð¾Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ profiles.weight_kg';
COMMENT ON TABLE public.weight_reminders IS 'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð²ÐµÑÐ°';

COMMENT ON COLUMN public.weight_history.weight_kg IS 'Ð’ÐµÑ Ð² ÐºÐ¸Ð»Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð°Ñ… (ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ Ñ profiles.weight_kg)';
COMMENT ON COLUMN public.weight_history.source IS 'Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð·Ð°Ð¿Ð¸ÑÐ¸: manual, profile_update, weekly_check';
COMMENT ON COLUMN public.user_subscriptions.expires_at IS 'Ð”Ð°Ñ‚Ð° Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ (NULL Ð´Ð»Ñ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ð¹)';

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð²ÐµÑÐ° Ð¸Ð· profiles Ð² weight_history Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸
CREATE OR REPLACE FUNCTION sync_weight_to_history()
RETURNS TRIGGER AS $$
BEGIN
    -- Ð•ÑÐ»Ð¸ Ð²ÐµÑ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ, Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
    IF OLD.weight_kg IS DISTINCT FROM NEW.weight_kg AND NEW.weight_kg IS NOT NULL THEN
        INSERT INTO public.weight_history (user_id, weight_kg, source, recorded_at)
        VALUES (NEW.id, NEW.weight_kg, 'profile_update', timezone('utc'::text, now()));
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸
DROP TRIGGER IF EXISTS trigger_sync_weight_to_history ON public.profiles;
CREATE TRIGGER trigger_sync_weight_to_history
    AFTER UPDATE OF weight_kg ON public.profiles
    FOR EACH ROW
    EXECUTE FUNCTION sync_weight_to_history();

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹, ÐµÑÐ»Ð¸ ÐµÐµ ÐµÑ‰Ðµ Ð½ÐµÑ‚
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS notifications_enabled BOOLEAN DEFAULT true;

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ (Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸)
/*
INSERT INTO public.user_subscriptions (user_id, plan, is_active) 
SELECT id, 'vip', true FROM public.profiles WHERE telegram_id = YOUR_TELEGRAM_ID
ON CONFLICT (user_id) DO NOTHING;
*/

-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸
SELECT 'Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° ÐµÐ¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð²ÐµÑÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð¿Ð¾Ð´ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ ÑÑ…ÐµÐ¼Ñƒ Ð‘Ð”! ðŸŽ‰' as result; 

ALTER TABLE public.user_subscriptions
ADD COLUMN IF NOT EXISTS promo_activated_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS promo_expires_at TIMESTAMPTZ;

COMMENT ON COLUMN public.user_subscriptions.promo_activated_at IS 'Ð’Ñ€ÐµÐ¼Ñ, ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð¿Ñ€Ð¾Ð¼Ð¾-Ð¿ÐµÑ€Ð¸Ð¾Ð´';
COMMENT ON COLUMN public.user_subscriptions.promo_expires_at IS 'Ð’Ñ€ÐµÐ¼Ñ, ÐºÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¾Ð¼Ð¾-Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚';


ALTER TABLE public.user_subscriptions
ADD COLUMN IF NOT EXISTS promo_activated_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS promo_expires_at TIMESTAMPTZ;

COMMENT ON COLUMN public.user_subscriptions.promo_activated_at IS 'Ð’Ñ€ÐµÐ¼Ñ, ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð¿Ñ€Ð¾Ð¼Ð¾-Ð¿ÐµÑ€Ð¸Ð¾Ð´';
COMMENT ON COLUMN public.user_subscriptions.promo_expires_at IS 'Ð’Ñ€ÐµÐ¼Ñ, ÐºÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¾Ð¼Ð¾-Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚';


-- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
CREATE TABLE IF NOT EXISTS public.daily_usage (
    id SERIAL PRIMARY KEY,
    telegram_id BIGINT NOT NULL,
    date DATE NOT NULL,
    photos_processed INTEGER DEFAULT 0,
    ai_questions INTEGER DEFAULT 0,
    meal_logs INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(telegram_id, date)
);

-- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
CREATE TABLE IF NOT EXISTS public.user_actions (
    id SERIAL PRIMARY KEY,
    telegram_id BIGINT NOT NULL,
    action_type VARCHAR(50) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    data JSONB
);

-- Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
CREATE INDEX IF NOT EXISTS idx_daily_usage_telegram_id ON public.daily_usage(telegram_id);
CREATE INDEX IF NOT EXISTS idx_daily_usage_date ON public.daily_usage(date);
CREATE INDEX IF NOT EXISTS idx_user_actions_telegram_id ON public.user_actions(telegram_id);
CREATE INDEX IF NOT EXISTS idx_user_actions_type ON public.user_actions(action_type);
CREATE INDEX IF NOT EXISTS idx_user_actions_created_at ON public.user_actions(created_at);

-- Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ RLS
ALTER TABLE public.daily_usage ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_actions ENABLE ROW LEVEL SECURITY;

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
CREATE POLICY "Allow public all operations on daily_usage"
ON public.daily_usage FOR ALL
TO public
USING (true);

CREATE POLICY "Allow public all operations on user_actions"
ON public.user_actions FOR ALL
TO public
USING (true);

-- ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ðº Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼
COMMENT ON TABLE public.daily_usage IS 'Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸';
COMMENT ON COLUMN public.daily_usage.telegram_id IS 'ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Telegram';
COMMENT ON COLUMN public.daily_usage.date IS 'Ð”Ð°Ñ‚Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ';
COMMENT ON COLUMN public.daily_usage.photos_processed IS 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð¾Ñ‚Ð¾ Ð·Ð° Ð´ÐµÐ½ÑŒ';
COMMENT ON COLUMN public.daily_usage.ai_questions IS 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº Ð˜Ð˜ Ð·Ð° Ð´ÐµÐ½ÑŒ';
COMMENT ON COLUMN public.daily_usage.meal_logs IS 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¾ ÐµÐ´Ðµ Ð·Ð° Ð´ÐµÐ½ÑŒ';

COMMENT ON TABLE public.user_actions IS 'Ð›Ð¾Ð³ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹';
COMMENT ON COLUMN public.user_actions.telegram_id IS 'ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Telegram';
COMMENT ON COLUMN public.user_actions.action_type IS 'Ð¢Ð¸Ð¿ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ';
COMMENT ON COLUMN public.user_actions.data IS 'Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¸';

-- ðŸ“Š ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð• Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð« ÐŸÐžÐ”ÐŸÐ˜Ð¡ÐžÐš Ð”Ð›Ð¯ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ« ÐŸÐ ÐžÐœÐž

-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¼Ð¾-ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
ALTER TABLE public.user_subscriptions 
ADD COLUMN IF NOT EXISTS promo_activated_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS promo_expires_at TIMESTAMP WITH TIME ZONE;

-- ÐžÐ±Ð½Ð¾Ð²Ð¸Ð¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
UPDATE public.user_subscriptions 
SET plan = 'free' 
WHERE plan IS NULL;

-- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_promo_expires 
ON public.user_subscriptions(promo_expires_at) 
WHERE promo_expires_at IS NOT NULL;

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
CREATE OR REPLACE FUNCTION get_user_subscription_by_telegram_id(p_telegram_id BIGINT)
RETURNS TABLE(
    tier TEXT,
    expires_at TIMESTAMP WITH TIME ZONE,
    promo_activated_at TIMESTAMP WITH TIME ZONE,
    promo_expires_at TIMESTAMP WITH TIME ZONE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        us.plan as tier,
        us.expires_at,
        us.promo_activated_at,
        us.promo_expires_at
    FROM public.user_subscriptions us
    JOIN public.profiles p ON p.id = us.user_id
    WHERE p.telegram_id = p_telegram_id;
END;
$$ LANGUAGE plpgsql;

-- === Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯ Ð¡ Ð®KASSA ===

-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· Ð®Kassa
CREATE TABLE IF NOT EXISTS public.yukassa_payments (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    telegram_id BIGINT NOT NULL,
    payment_id UUID NOT NULL UNIQUE, -- ID Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð° Ð¸Ð· Ð®Kassa
    amount DECIMAL(10,2) NOT NULL, -- Ð¡ÑƒÐ¼Ð¼Ð° Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°
    currency VARCHAR(3) NOT NULL DEFAULT 'RUB',
    subscription_tier VARCHAR(20) NOT NULL, -- 'progress' Ð¸Ð»Ð¸ 'maximum'
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, succeeded, failed, canceled
    payment_url TEXT, -- Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
    confirmation_token TEXT, -- Ð¢Ð¾ÐºÐµÐ½ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð®Kassa
    paid_at TIMESTAMP WITH TIME ZONE, -- Ð’Ñ€ÐµÐ¼Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL, -- Ð’Ñ€ÐµÐ¼Ñ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÑÑ‹Ð»ÐºÐ¸
    metadata JSONB, -- Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Ð®Kassa
    webhook_received_at TIMESTAMP WITH TIME ZONE, -- Ð’Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ webhook
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹
CREATE INDEX IF NOT EXISTS idx_yukassa_payments_user_id ON public.yukassa_payments(user_id);
CREATE INDEX IF NOT EXISTS idx_yukassa_payments_telegram_id ON public.yukassa_payments(telegram_id);
CREATE INDEX IF NOT EXISTS idx_yukassa_payments_payment_id ON public.yukassa_payments(payment_id);
CREATE INDEX IF NOT EXISTS idx_yukassa_payments_status ON public.yukassa_payments(status);
CREATE INDEX IF NOT EXISTS idx_yukassa_payments_created_at ON public.yukassa_payments(created_at);

-- Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Row Level Security
ALTER TABLE public.yukassa_payments ENABLE ROW LEVEL SECURITY;

-- ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
CREATE POLICY "Allow public all operations on yukassa_payments" 
ON public.yukassa_payments FOR ALL 
TO public 
USING (true) 
WITH CHECK (true);

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
CREATE OR REPLACE FUNCTION activate_subscription_after_payment(
    p_telegram_id BIGINT,
    p_subscription_tier VARCHAR(20),
    p_payment_id UUID
)
RETURNS BOOLEAN AS $$
DECLARE
    v_user_id BIGINT;
    v_expires_at TIMESTAMP WITH TIME ZONE;
BEGIN
    -- ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ user_id Ð¿Ð¾ telegram_id
    SELECT id INTO v_user_id 
    FROM public.profiles 
    WHERE telegram_id = p_telegram_id;
    
    IF v_user_id IS NULL THEN
        RETURN FALSE;
    END IF;
    
    -- Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ (30 Ð´Ð½ÐµÐ¹)
    v_expires_at := timezone('utc'::text, now()) + INTERVAL '30 days';
    
    -- ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
    INSERT INTO public.user_subscriptions (user_id, plan, tier, is_active, expires_at, payment_id, updated_at)
    VALUES (v_user_id, p_subscription_tier, p_subscription_tier, TRUE, v_expires_at, p_payment_id::TEXT, timezone('utc'::text, now()))
    ON CONFLICT (user_id) 
    DO UPDATE SET
        plan = p_subscription_tier,
        tier = p_subscription_tier,
        is_active = TRUE,
        expires_at = v_expires_at,
        payment_id = p_payment_id::TEXT,
        updated_at = timezone('utc'::text, now());
    
    -- ÐžÑ‚Ð¼ÐµÑ‡Ð°ÐµÐ¼ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ ÐºÐ°Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹
    UPDATE public.yukassa_payments
    SET 
        status = 'succeeded',
        paid_at = timezone('utc'::text, now()),
        webhook_received_at = timezone('utc'::text, now()),
        updated_at = timezone('utc'::text, now())
    WHERE payment_id = p_payment_id;
    
    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;

-- ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ðº Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ
COMMENT ON TABLE public.yukassa_payments IS 'ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· Ð®Kassa API';
COMMENT ON COLUMN public.yukassa_payments.payment_id IS 'Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ID Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð° Ð¾Ñ‚ Ð®Kassa';
COMMENT ON COLUMN public.yukassa_payments.amount IS 'Ð¡ÑƒÐ¼Ð¼Ð° Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð° Ð² Ñ€ÑƒÐ±Ð»ÑÑ…';
COMMENT ON COLUMN public.yukassa_payments.subscription_tier IS 'Ð¢Ð¸Ð¿ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸: progress (199â‚½) Ð¸Ð»Ð¸ maximum (349â‚½)';
COMMENT ON COLUMN public.yukassa_payments.status IS 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°: pending, succeeded, failed, canceled';
COMMENT ON COLUMN public.yukassa_payments.confirmation_token IS 'Ð¢Ð¾ÐºÐµÐ½ Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°';
COMMENT ON COLUMN public.yukassa_payments.metadata IS 'Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Ð®Kassa Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ JSON';
